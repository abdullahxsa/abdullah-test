<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>حاسبة أرباح المشاوير 🚗</title>

  <!-- 1) THEME: نحدّد ألوان لكل وضع -->
  <meta id="metaTheme" name="theme-color" content="#0f1115" />

  <script>
    // ===== إعداد المسار الأساسي لملفات الـPWA =====
    const BASE = "/abdullah-test/";
  </script>

  <link rel="manifest" href="/abdullah-test/manifest.webmanifest" />
  <link rel="icon" href="/abdullah-test/icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="/abdullah-test/icons/icon-192.png" />

  <style>
    /* =============== Theme System =============== */
    :root{
      --radius: 14px;
      --gap: 12px;
      --font: system-ui, "Noto Sans Arabic", Tahoma, sans-serif;

      /* Light (fallback) */
      --bg: #ffffff;
      --fg: #111827;
      --muted:#6b7280;
      --card:#f7f8fa;
      --field:#f1f5f9;
      --stroke:#e5e7eb;
      --brand:#3b82f6;
      --ok:#16a34a;
      --bad:#ef4444;
    }
    /* Dark */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115; --fg:#e8eaef; --muted:#9aa3af;
        --card:#151923; --field:#0d1017; --stroke:#222838;
        --brand:#6aa0ff; --ok:#39d98a; --bad:#ff6b6b;
      }
    }
    /* عندما يختار المستخدم وضع محدد */
    :root[data-theme="dark"]{
      --bg:#0f1115; --fg:#e8eaef; --muted:#9aa3af;
      --card:#151923; --field:#0d1017; --stroke:#222838;
      --brand:#6aa0ff; --ok:#39d98a; --bad:#ff6b6b;
    }
    :root[data-theme="light"]{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280;
      --card:#f7f8fa; --field:#f1f5f9; --stroke:#e5e7eb;
      --brand:#3b82f6; --ok:#16a34a; --bad:#ef4444;
    }

    /* =============== Base =============== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:var(--font); font-size:16px; /* يمنع تكبير iOS */
    }
    .wrap{max-width:980px;margin:auto; padding:16px 16px 28px}
    header{
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:14px
    }
    h1{margin:0;font-size:26px;line-height:1.2}
    .theme-toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px; border:1px solid var(--stroke);
      background:var(--card); color:var(--fg); cursor:pointer; user-select:none;
    }
    .grid{
      display:grid; gap:var(--gap);
      grid-template-columns:1fr;        /* جوال: عمود واحد */
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1.2fr 1fr; }  /* شاشات أوسع: عمودين */
    }
    .card{
      background:var(--card); border:1px solid var(--stroke);
      border-radius:var(--radius); padding:14px;
    }

    /* حقول وأزرار */
    label{display:block;margin:4px 2px 6px;color:var(--muted);font-size:14px}
    input, select, button{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--stroke);
      background:var(--field); color:var(--fg);
    }
    input:focus, select:focus{outline:2px solid color-mix(in srgb, var(--brand) 60%, transparent)}
    button{background:var(--brand); color:#fff; border:none; font-weight:600; cursor:pointer}
    button.ghost{background:transparent;color:var(--fg);border:1px solid var(--stroke)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    /* وحدات الإحصائيات */
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .stat{background:var(--field);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .stat b{display:block;font-size:18px;margin-top:4px}
    @media (max-width:680px){ .stats{grid-template-columns:repeat(2,1fr)} }

    /* جدول مع تمرير أفقي */
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--stroke);margin-top:10px}
    table{min-width:760px;width:100%;border-collapse:collapse;background:var(--field)}
    th,td{padding:10px 12px;border-bottom:1px solid var(--stroke);text-align:right;font-size:14px}
    tr:hover td{background:color-mix(in srgb, var(--field) 85%, var(--brand) 15%)}
    .ok{color:var(--ok)} .bad{color:var(--bad)}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:680px){ .row{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>حاسبة أرباح المشاوير 🚗</h1>
      <button id="toggleTheme" class="theme-toggle" aria-label="تبديل الوضع">
        <span id="themeLabel">الوضع الليلي</span>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M21 12.79A9 9 0 0111.21 3a7 7 0 100 14A9 9 0 0021 12.79z"/>
        </svg>
      </button>
    </header>

    <div class="grid">
      <!-- العمود الأيسر: فلترة + إحصاءات -->
      <section class="card">
        <div class="row">
          <div>
            <label>فلترة</label>
            <select id="range">
              <option value="all">الكل</option>
              <option value="day">اليوم</option>
              <option value="week">الأسبوع</option>
              <option value="month">الشهر</option>
              <option value="year">السنة</option>
              <option value="custom">مخصّص</option>
            </select>
          </div>
          <div class="row">
            <div><label>من</label><input type="date" id="from"></div>
            <div><label>إلى</label><input type="date" id="to"></div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button id="applyFilter">تطبيق</button>
        </div>

        <div class="stats">
          <div class="stat"><span>صافي</span><b id="s_net">0</b></div>
          <div class="stat"><span>/ساعة</span><b id="s_hr">0</b></div>
          <div class="stat"><span>/مشوار</span><b id="s_ride">0</b></div>
          <div class="stat"><span>المشاوير</span><b id="s_rides">0</b></div>
        </div>
      </section>

      <!-- العمود الأيمن: الإدخال والحساب -->
      <section class="card">
        <div class="row">
          <div><label>تاريخ</label><input type="date" id="date" /></div>
          <div><label>ساعات العمل</label><input type="number" step="0.1" inputmode="decimal" id="hours" placeholder="8" /></div>
          <div><label>الدخل الكلي</label><input type="number" step="0.01" inputmode="decimal" id="gross" placeholder="260" /></div>
          <div><label>نسبة المنصة %</label><input type="number" step="0.01" inputmode="decimal" id="pct" placeholder="25" /></div>
          <div><label>بنزين</label><input type="number" step="0.01" inputmode="decimal" id="fuel" placeholder="35" /></div>
          <div><label>مصروفات أخرى</label><input type="number" step="0.01" inputmode="decimal" id="other" placeholder="10" /></div>
          <div><label>صيانة/استهلاك</label><input type="number" step="0.01" inputmode="decimal" id="maint" placeholder="20" /></div>
          <div><label>عدد المشاوير</label><input type="number" step="1" inputmode="numeric" id="rides" placeholder="15" /></div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button id="calcBtn">احسب وأضف</button>
          <button class="ghost" id="clearInputs">مسح</button>
          <button id="exportPdfBtn" class="btn btn-secondary w-full">تصدير PDF</button>
          <button class="ghost" id="installBtn" hidden>تثبيت التطبيق</button>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <div class="table-wrap">
        <table id="tbl" role="table" aria-label="سجل المشاوير">
          <thead>
            <tr>
              <th>تاريخ</th><th>ساعات</th><th>دخل</th><th>نسبة%</th>
              <th>عمولة</th><th>بنزين</th><th>أخرى</th><th>صيانة</th>
              <th>مشاوير</th><th>صافي</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="opacity:.65;font-size:12px;margin-top:8px">البيانات تُحفظ محليًا على جهازك (LocalStorage)</div>
    </section>
  </div>

  <script>
    // ====== Service Worker ======
    const swPath = BASE + 'sw.js';
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () =>
        navigator.serviceWorker.register(swPath, { scope: BASE }).catch(console.error)
      );
    }

    // ====== THEME: toggle + persist + theme-color meta ======
    const THEME_KEY = 'pref-theme';
    const root = document.documentElement;
    const metaTheme = document.getElementById('metaTheme');
    const toggleBtn = document.getElementById('toggleTheme');
    const themeLabel = document.getElementById('themeLabel');

    function applyTheme(t){
      if (t) root.setAttribute('data-theme', t);
      // اختر لون شريط المتصفح حسب الوضع
      const isDark = (root.getAttribute('data-theme') || '').includes('dark') ||
                     (!root.hasAttribute('data-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
      metaTheme.setAttribute('content', isDark ? '#0f1115' : '#ffffff');
      themeLabel.textContent = isDark ? 'الوضع النهاري' : 'الوضع الليلي';
    }
    // تحميل تفضيل سابق
    const saved = localStorage.getItem(THEME_KEY);
    if (saved) root.setAttribute('data-theme', saved);
    applyTheme(saved);

    toggleBtn.addEventListener('click', ()=>{
      const cur = root.getAttribute('data-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    });

    // ====== App logic (نفس الحسابات السابقة) ======
    const $ = id => document.getElementById(id);
    const inputs = ['date','hours','gross','pct','fuel','other','maint','rides'].map($);
    const [date,hours,gross,pct,fuel,other,maint,rides] = inputs;
    const s_net = $('s_net'), s_hr = $('s_hr'), s_ride = $('s_ride'), s_rides = $('s_rides');
    const tbody = document.querySelector('#tbl tbody');

    const KEY='trip-logs';
    const load=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
    const save=a=>localStorage.setItem(KEY,JSON.stringify(a));

    $('calcBtn').onclick=()=>{
      const d=date.value||new Date().toISOString().slice(0,10);
      const h=+hours.value||0, g=+gross.value||0, p=(+pct.value||0)/100;
      const f=+fuel.value||0, o=+other.value||0, m=+maint.value||0, r=+rides.value||0;
      const comm=g*p; const net=g-comm-f-o-m; const hr=h?net/h:0; const perRide=r?net/r:0;
      const row={d,h,g,pct:+pct.value||0,comm:+comm.toFixed(2),f,o,m,r,net:+net.toFixed(2),hr:+hr.toFixed(2),perRide:+perRide.toFixed(2)};
      const arr=load(); arr.push(row); save(arr); render();
    };
    $('clearInputs').onclick=()=>inputs.forEach(i=>i.value='');
    $('exportCsv').onclick=()=>{
      const arr=load(); if(!arr.length) return alert('لا يوجد بيانات');
      const header=['date','hours','gross','pct','comm','fuel','other','maint','rides','net','hr','perRide'];
      const lines=[header.join(',')];
      for(const r of arr) lines.push([r.d,r.h,r.g,r.pct,r.comm,r.f,r.o,r.m,r.r,r.net,r.hr,r.perRide].join(','));
      const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='logs.csv'; a.click(); URL.revokeObjectURL(a.href);
    };

    const range=$('range'), from=$('from'), to=$('to');
    $('applyFilter').onclick=render;
    range.addEventListener('change', ()=>{
      const t=new Date();
      if(range.value==='day'){ const d=t.toISOString().slice(0,10); from.value=d; to.value=d; }
      else if(range.value==='week'){ const s=new Date(t); s.setDate(t.getDate()-6); from.value=s.toISOString().slice(0,10); to.value=t.toISOString().slice(0,10); }
      else if(range.value==='month'){ const s=new Date(t.getFullYear(),t.getMonth(),1); from.value=s.toISOString().slice(0,10); to.value=t.toISOString().slice(0,10); }
      else if(range.value==='year'){ const s=new Date(t.getFullYear(),0,1); from.value=s.toISOString().slice(0,10); to.value=t.toISOString().slice(0,10); }
      else { from.value=''; to.value=''; }
    });

    function within(d,a,b){
      if(!a && !b) return true;
      const ts=+new Date(d), s=a?+new Date(a):-Infinity, e=b?+new Date(b):Infinity;
      return ts>=s && ts<=e;
    }
    function filter(arr){ const a=from.value||null, b=to.value||null; return arr.filter(r=>within(r.d,a,b)); }

    function render(){
      const arr=filter(load());
      tbody.innerHTML=''; let sum=0, hrs=0, rs=0;
      for(const r of arr){
        sum+=+r.net; hrs+=+r.h; rs+=+r.r;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.d}</td><td>${r.h}</td><td>${r.g}</td><td>${r.pct}%</td>
                      <td>${r.comm}</td><td>${r.f}</td><td>${r.o}</td><td>${r.m}</td>
                      <td>${r.r}</td><td class="${r.net>=0?'ok':'bad'}">${r.net}</td>`;
        tbody.appendChild(tr);
      }
      s_net.textContent=sum.toFixed(2);
      s_hr.textContent=(hrs? (sum/hrs):0).toFixed(2);
      s_ride.textContent=(rs? (sum/rs):0).toFixed(2);
      s_rides.textContent=rs;
    }

    date.value=new Date().toISOString().slice(0,10);
    render();

    // PWA install prompt
    let deferred; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferred=e;installBtn.hidden=false});
    installBtn?.addEventListener('click',async()=>{if(!deferred)return;deferred.prompt();await deferred.userChoice;deferred=null;installBtn.hidden=true});
  </script>
</body>
</html>

<!-- PDF deps -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const { jsPDF } = window.jspdf;

  async function exportToPDF() {
    const root = document.getElementById('report-root');
    if (!root) {
      alert('لم يتم العثور على جزء التقرير لتصديره.');
      return;
    }

    const prevBg = root.style.backgroundColor;
    root.style.backgroundColor = '#ffffff';

    const canvas = await html2canvas(root, {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff'
    });

    root.style.backgroundColor = prevBg;

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');

    const pageWidth = 210;
    const pageHeight = 297;

    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let remainingHeight = imgHeight;
    let position = 10;

    while (remainingHeight > 0) {
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      remainingHeight -= pageHeight;
      if (remainingHeight > 0) {
        pdf.addPage();
        position = 10 - pageHeight;
      }
    }

    const today = new Date();
    const pad = n => String(n).padStart(2, '0');
    const fileName = تقرير_المشاوير_--.pdf;

    pdf.save(fileName);
  }

  document.getElementById('exportPdfBtn')?.addEventListener('click', exportToPDF);
</script>

<style>
  #report-root { padding: 12px; }
  @media (max-width: 480px) {
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
  }
  .table-wrapper { overflow-x: auto; }
</style>
</body>

<!-- PDF deps -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const { jsPDF } = window.jspdf;

  async function exportToPDF() {
    const root = document.getElementById('report-root');
    if (!root) {
      alert('لم يتم العثور على جزء التقرير لتصديره.');
      return;
    }

    const prevBg = root.style.backgroundColor;
    root.style.backgroundColor = '#ffffff';

    const canvas = await html2canvas(root, {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff'
    });

    root.style.backgroundColor = prevBg;

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');

    const pageWidth = 210;
    const pageHeight = 297;

    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let remainingHeight = imgHeight;
    let position = 10;

    while (remainingHeight > 0) {
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      remainingHeight -= pageHeight;
      if (remainingHeight > 0) {
        pdf.addPage();
        position = 10 - pageHeight;
      }
    }

    const today = new Date();
    const pad = n => String(n).padStart(2, '0');
    const fileName = تقرير_المشاوير_--.pdf;

    pdf.save(fileName);
  }

  document.getElementById('exportPdfBtn')?.addEventListener('click', exportToPDF);
</script>

<style>
  #report-root { padding: 12px; }
  @media (max-width: 480px) {
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
  }
  .table-wrapper { overflow-x: auto; }
</style>
</body>
