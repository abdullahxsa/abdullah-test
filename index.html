<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة أرباح المشاوير</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1115">
  <style>
    :root{--bg:#0f1115;--card:#171a21;--text:#e9eef4;--muted:#9aa4b2;--acc:#2dd4bf;--danger:#ef4444;border:none}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;text-align:center;border-bottom:1px solid #222}
    h1{margin:0;font-size:22px}
    .container{max-width:800px;margin:20px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid #222;border-radius:14px;padding:16px;margin-bottom:14px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row .full{grid-column:1/-1}
    label{font-size:13px;color:var(--muted)}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid #2a2f3a;background:#0c0f14;color:#e9eef4}
    input:focus,select:focus{outline:2px solid #2dd4bf}
    button{background:var(--acc);color:#071d1a;border:none;cursor:pointer;font-weight:600}
    button.secondary{background:#0c0f14;border:1px solid #2a2f3a;color:#e9eef4}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid #2a2f3a;background:#0c0f14;color:#e9eef4;cursor:pointer;font-size:13px}
    .tab.active{background:var(--acc);color:#06221e;border-color:transparent}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #21242b;padding:10px;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .right{text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .total{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:#0c0f14;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px}
    .danger{color:#fca5a5}
    footer{padding:24px 16px;text-align:center;color:#6b7280;font-size:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header><h1>🚕 حاسبة أرباح المشاوير</h1></header>

  <div class="container">

    <!-- إدخال رحلة جديدة -->
    <div class="card">
      <h3 style="margin-top:0">إضافة مشوار</h3>
      <div class="row">
        <div>
          <label>إجمالي الدخل (قبل خصم المنصة) – ريال</label>
          <input id="income" type="number" min="0" step="0.5" placeholder="مثال: 260">
        </div>
        <div>
          <label>تكلفة البنزين – ريال</label>
          <input id="fuel" type="number" min="0" step="0.5" placeholder="مثال: 35">
        </div>
        <div>
          <label>نسبة المنصة % (أوبر/كريم..)</label>
          <input id="platform" type="number" min="0" step="0.5" placeholder="مثال: 25">
        </div>
        <div>
          <label>مصروفات أخرى (مواقف/مياه..) – ريال</label>
          <input id="extras" type="number" min="0" step="0.5" placeholder="مثال: 10">
        </div>
        <div>
          <label>ساعات العمل الفعلية</label>
          <input id="hours" type="number" min="0" step="0.5" placeholder="مثال: 5.5">
        </div>
        <div>
          <label>تاريخ المشوار</label>
          <input id="date" type="date">
        </div>
        <div class="full">
          <button id="addBtn">إضافة للمشوار</button>
        </div>
      </div>
      <div class="muted">يتم حفظ البيانات محليًا (offline) – تقدر تصدّر CSV.</div>
    </div>

    <!-- الفلاتر و الجدول -->
    <div class="card">
      <div class="tabs" id="filters">
        <button class="tab active" data-range="all">الكل</button>
        <button class="tab" data-range="day">يومي</button>
        <button class="tab" data-range="week">أسبوعي</button>
        <button class="tab" data-range="month">شهري</button>
        <button class="tab" data-range="year">سنوي</button>
      </div>

      <table id="table">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>الدخل</th>
            <th>بنزين</th>
            <th>نسبة المنصة</th>
            <th>مصروفات</th>
            <th>صافي الربح</th>
            <th class="right">حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="secondary" id="exportCsv">تصدير CSV</button>
        <button class="secondary" id="clearAll">مسح السجل</button>
      </div>
    </div>

    <!-- الإجماليات -->
    <div class="card">
      <h3 style="margin-top:0">الإجماليات (حسب الفلتر المختار)</h3>
      <div class="total">
        <div class="chip">إجمالي الدخل: <b id="sumIncome">0</b> ريال</div>
        <div class="chip danger">خصم المنصة: <b id="sumPlatform">0</b> ريال</div>
        <div class="chip danger">بنزين + مصروفات: <b id="sumCosts">0</b> ريال</div>
        <div class="chip">صافي الربح: <b id="sumNet">0</b> ريال</div>
      </div>
    </div>

  </div>

  <footer>تطبيق تجريبي يدعم العمل بدون إنترنت (PWA)</footer>

  <script>
    // تخزين محلي
    const key = "trips_v1";
    const $ = (id)=>document.getElementById(id);
    const tbody = document.querySelector("#table tbody");
    const filters = document.getElementById("filters");
    let currentRange = "all";

    const load = () => JSON.parse(localStorage.getItem(key) || "[]");
    const save = (arr) => localStorage.setItem(key, JSON.stringify(arr));

    function calcNet(t){
      const plat = (t.income * (t.platform/100));
      const costs = plat + t.fuel + t.extras;
      const net = t.income - costs;
      return {plat: round(plat), costs: round(costs), net: round(net)};
    }
    const round = n => Math.round(n*100)/100;

    function addTrip(){
      const t = {
        id: crypto.randomUUID(),
        date: $("date").value || new Date().toISOString().slice(0,10),
        income: +$("income").value || 0,
        fuel: +$("fuel").value || 0,
        platform: +$("platform").value || 0,
        extras: +$("extras").value || 0,
        hours: +$("hours").value || 0
      };
      const trips = load();
      trips.unshift(t);
      save(trips);
      render();
      clearInputs();
    }

    function clearInputs(){
      ["income","fuel","platform","extras","hours"].forEach(id=>$(id).value="");
    }

    function inRange(d,range){
      const dt = new Date(d);
      const now = new Date();
      switch(range){
        case "day":
          return dt.toDateString()===now.toDateString();
        case "week":{
          const start = new Date(now); start.setDate(now.getDate()-6);
          start.setHours(0,0,0,0);
          return dt>=start && dt<=now;
        }
        case "month":{
          return dt.getMonth()===now.getMonth() && dt.getFullYear()===now.getFullYear();
        }
        case "year":{
          return dt.getFullYear()===now.getFullYear();
        }
        default: return true;
      }
    }

    function render(){
      const trips = load().filter(t=>inRange(t.date,currentRange));
      tbody.innerHTML = "";
      let sumIncome=0,sumPlat=0,sumCosts=0,sumNet=0;
      for(const t of trips){
        const c = calcNet(t);
        sumIncome += t.income;
        sumPlat   += c.plat;
        sumCosts  += (t.fuel + t.extras + c.plat);
        sumNet    += c.net;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.date}</td>
          <td>${t.income}</td>
          <td>${t.fuel}</td>
          <td>${t.platform}%</td>
          <td>${t.extras}</td>
          <td><b>${c.net}</b></td>
          <td class="right"><button class="secondary" data-del="${t.id}">حذف</button></td>
        `;
        tbody.appendChild(tr);
      }
      $("sumIncome").textContent = round(sumIncome);
      $("sumPlatform").textContent = round(sumPlat);
      $("sumCosts").textContent = round(sumCosts);
      $("sumNet").textContent = round(sumNet);
    }

    // تصدير CSV
    function exportCSV(){
      const trips = load();
      const rows = [["date","income","fuel","platform%","extras","hours","net"]];
      for(const t of trips){
        const c = calcNet(t);
        rows.push([t.date,t.income,t.fuel,t.platform,t.extras,t.hours,c.net]);
      }
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "trips.csv";
      a.click();
    }

    // حذف
    tbody.addEventListener("click",(e)=>{
      const id = e.target.dataset.del;
      if(!id) return;
      const trips = load().filter(t=>t.id!==id);
      save(trips); render();
    });

    // أحداث
    $("addBtn").onclick = addTrip;
    $("exportCsv").onclick = exportCSV;
    $("clearAll").onclick = ()=>{ if(confirm("مسح كل السجل؟")){ save([]); render(); } };
    filters.addEventListener("click",(e)=>{
      if(!e.target.classList.contains("tab")) return;
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      e.target.classList.add("active");
      currentRange = e.target.dataset.range;
      render();
    });

    // أول رسم
    render();

    // تسجبل سيرفس ووركر (PWA)
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=> {
        navigator.serviceWorker.register("./sw.js").catch(console.error);
      });
    }
  </script>
</body>
</html>
